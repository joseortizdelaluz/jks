<section class="container-fluid">
    <app-header-apps-label appName="Ventas" class="row"></app-header-apps-label>

    <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-12">
            <span>Empresa</span>
            <ng-select [items]="list_root_emisor" bindLabel="razon_social" bindValue="id"
                (change)="selectedCompanyRoot($event)" [(ngModel)]="filter.company_id"
                placeholder="Seleccione una opción">
            </ng-select>
        </div>

        <div class="col-lg-6 col-md-6 col-sm-12">
            <span>Cliente</span>
            <ng-select [items]="list_root_receptor" bindLabel="razon_social" bindValue="id"
                [(ngModel)]="filter.customer_id" placeholder="Seleccione una opción">
            </ng-select>
        </div>

        <div class="col-lg-3 col-md-3 col-sm-12">
            <span>Sucursal</span>
            <ng-select [items]="list_root_sucursal" bindLabel="nombre" bindValue="id"
                [(ngModel)]="filter.branch_company_id" placeholder="Seleccione">
            </ng-select>
        </div>

        <div class="col-lg-2 col-md-2 col-sm-12">
            <span>Fecha inicio</span>
            <input type="date" class="form-control" [(ngModel)]="filter.fecha_inicio">
        </div>

        <div class="col-lg-2 col-md-2 col-sm-12">
            <span>Fecha fin</span>
            <input type="date" class="form-control" [(ngModel)]="filter.fecha_inicio">
        </div>

        <div class="col-lg-5 col-md-5 col-sm-12">
            <span for="folio">Folio</span>
            <div class="input-group mb-3">
                <input type="text" class="form-control" [(ngModel)]="filter.folio" placeholder="Folio; P/e:152,262,100" aria-label="Recipient's username" aria-describedby="button-addon2">
                <button class="btn btn-primary btn-sm" type="button" (click)="load()">
                    <i class="fas fa-search fa-sm fa-fw"></i>
                    Buscar
                </button>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            <div class="btn-group">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Ventas
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <button type="button" class="dropdown-item btn btn-danger" (click)="openCreate()"
                            style="text-align: start;">
                            <i class="fas fa-plus fa-lg fa-fw text-success"></i>
                            Agregar
                        </button>
                    </li>
                    <li>
                        <button type="button" class="dropdown-item btn btn-danger" (click)="openEdit()"
                            style="text-align: start;">
                            <i class="fas fa-pencil-alt fa-lg fa-fw text-warning"></i>
                            Editar
                        </button>
                    </li>
                    <li>
                        <button type="button" class="dropdown-item btn btn-danger" (click)="openView()"
                            style="text-align: start;">
                            <i class="fas fa-clipboard fa-lg fa-fw text-primary"></i>
                            Visualizar
                        </button>
                    </li>
                    <li>
                        <button type="button" class="dropdown-item btn btn-danger" (click)="openDelete()"
                            style="text-align: start;">
                            <i class="fas fa-trash-alt fa-lg fa-fw text-danger"></i>
                            Eliminar
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <jqxGrid #jqxGridVentas (onRowselect)="seleccionarRegistro($event)" [width]="'100%'"
                [source]="dataAdapter" [columns]="columns" [selectionmode]="'multiplerowsadvanced'">
            </jqxGrid>
        </div>
    </div>


    <!-- Modal crea editar documento -->
    <ng-template #modalCE let-modal>
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ this.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                    (click)="modal.close()"></button>
            </div>
            <form [formGroup]="form" novalidate (ngSubmit)="save($event)" class="py-2">
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-lg-8 col-md-8 col-sm-12">
                                <span><strong class="text-danger">*</strong> Emisor</span>
                                <ng-select [items]="list_ce_companys" bindLabel="razon_social" bindValue="id"
                                    placeholder="Selccione una opción" (change)="selectedCompanyCE($event)"
                                    formControlName="company_id">
                                </ng-select>
                                <div
                                    *ngIf="getFormControl('company_id', form)?.errors && getFormControl('company_id', form)?.touched">
                                    <small *ngIf="getFormControl('company_id', form)?.hasError('required')"
                                        class="text-danger">
                                        Seleccione una <strong>empresa</strong>.
                                    </small>
                                </div>
                            </div>

                            <div class="col-lg-4 col-md-4 col-sm-12">
                                <span><strong class="text-danger">*</strong> Sucursal</span>
                                <ng-select [items]="list_ce_branchs" bindLabel="nombre" bindValue="id"
                                    placeholder="Selccione una opción" formControlName="branch_company_id">
                                </ng-select>
                                <div
                                    *ngIf="getFormControl('branch_company_id', form)?.errors && getFormControl('branch_company_id', form)?.touched">
                                    <small *ngIf="getFormControl('branch_company_id', form)?.hasError('required')"
                                        class="text-danger">
                                        Seleccione una <strong>sucursal</strong>.
                                    </small>
                                </div>
                            </div>
                        </div>
                        <br>

                        <div class="row">
                            <div class="col-md-4 col-lg-4 col-sm-12">
                                <span><strong class="text-danger">*</strong> Cliente</span>
                                <ng-select [items]="list_ce_customers" bindLabel="razon_social" bindValue="id"
                                    placeholder="Selccione una opción" (change)="selectedCustomerCE($event)"
                                    formControlName="client_id">
                                </ng-select>
                                <div
                                    *ngIf="getFormControl('client_id', form)?.errors && getFormControl('client_id', form)?.touched">
                                    <small *ngIf="getFormControl('client_id', form)?.hasError('required')"
                                        class="text-danger">
                                        Seleccione el <strong>cliente</strong>.
                                    </small>
                                </div>
                            </div>

                            <div class="col-md-8 col-lg-8 col-sm-12">
                                <span>Observaciones</span>
                                <textarea formControlName="observaciones" rows="3" class="form-control"></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-12 col-md-3 col-lg-3">
                                <span><strong class="text-danger">*</strong> Divisa</span>
                                <ng-select placeholder="Seleccione una opción" formControlName="divisa_id"
                                    [readonly]="form.get('tipo_comprobante')?.value=='P'">
                                    <ng-option *ngFor="let item of list_ce_divisas" [value]="item.id"><strong>{{
                                            item.clave }}</strong> - {{ item.descripcion }}</ng-option>
                                </ng-select>
                                <div
                                    *ngIf="getFormControl('divisa_id', form)?.errors && getFormControl('divisa_id', form)?.touched">
                                    <small *ngIf="getFormControl('divisa_id', form)?.hasError('required')"
                                        class="text-danger">
                                        Seleccione la <strong>divisa</strong>.
                                    </small>
                                </div>
                            </div>

                            <!-- <div class="col-sm-12 col-md-3 col-lg-3">
                                <span><strong class="text-danger">*</strong> Precio</span>
                                <ng-select [items]="list_ce_precios" bindLabel="nombre" bindValue="id"
                                    placeholder="Selccione una opción" formControlName="precio_id">

                                </ng-select>
                                <div
                                    *ngIf="getFormControl('precio_id', form)?.errors && getFormControl('precio_id', form)?.touched">
                                    <small *ngIf="getFormControl('precio_id', form)?.hasError('required')"
                                        class="text-danger">
                                        Seleccione el <strong>precio</strong> aplicado.
                                    </small>
                                </div>
                            </div> -->

                            <!-- <div class="col-sm-12 col-md-3 col-lg-3">
                                <span><strong class="text-danger">*</strong> Fecha creación</span>
                                <input type="datetime-local" placeholder="yyyy-MM-ddTHH:mm:ss" class="form-control"
                                    formControlName="fecha_creacion">
                                <div
                                    *ngIf="getFormControl('fecha_creacion', form)?.errors && getFormControl('fecha_creacion', form)?.touched">
                                    <small *ngIf="getFormControl('fecha_creacion', form)?.hasError('required')"
                                        class="text-danger">
                                        Proporcione la fecha.
                                    </small>
                                </div>
                            </div> -->
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <strong>Entradas</strong>
                                <table formArrayName="detalles" class="table table-striped table-sm table-bordered">
                                    <thead class="bg-secondary thead-secondary"
                                        style="color: rgb(255, 255, 255); --darkreader-inline-color: #e8e6e3;"
                                        data-darkreader-inline-color="">
                                        <tr>
                                            <th style="width: 20%;">
                                                <small>
                                                    Producto
                                                </small>
                                            </th>
                                            <th style="width: 10%;">
                                                <small style="font-weight: bold;">
                                                    P. Unitario
                                                </small>
                                            </th>
                                            <th style="width: 7%;">
                                                <small style="font-weight: bold;">
                                                    Descuento
                                                </small>
                                            </th>
                                            <th style="width: 10%;">
                                                <small style="font-weight: bold;">
                                                    Cantidad
                                                </small>
                                            </th>
                                            <th style="width: 10%;">
                                                <small style="font-weight: bold;">
                                                    Impuestos
                                                </small>
                                            </th>
                                            <th style="width: 10%;text-align: right;">
                                                <small style="font-weight: bold;">
                                                    Total
                                                </small>
                                            </th>
                                            <th style="width: 5%;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let detalle of getFormArray('detalles', form).controls; let i = index;"
                                            [formGroupName]="i">
                                            <td>
                                                <input type="text" class="form-control" formControlName="concepto"
                                                    [ngbTypeahead]="searchProduct" [resultFormatter]="resultFormatter"
                                                    [inputFormatter]="inputFormatter" [resultTemplate]="rcp"
                                                    (selectItem)="selectedProduct($event.item, i)"
                                                    #instance="ngbTypeahead" placeholder="Busqueda por clave o nombre"
                                                    typeaheadOptionField="cp" />
                                                <ng-template #rcp let-r="result" let-t="term">
                                                    <div class="media p-1">
                                                        <div class="media-body">
                                                            <span>
                                                                <strong class="text-primary">{{r.clave}}</strong>
                                                                {{r.nombre}}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                                <div *ngIf="searching">
                                                    <small class="form-text text-muted">Buscando...</small>
                                                </div>
                                                <div *ngIf="searchFailed">
                                                    <div class="invalid-feedback">Sin resultados.</div>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="number" formControlName="precio_unitario"
                                                    class="form-control" (change)="changeEntry(i)">
                                            </td>
                                            <td>
                                                <input type="number" formControlName="descuento" class="form-control"
                                                    (change)="changeEntry(i)">
                                            </td>
                                            <td>
                                                <input type="number" formControlName="cantidad" class="form-control"
                                                    (change)="changeEntry(i)">
                                            </td>
                                            <td>
                                                <div *ngIf="detalle.value['impuestos'].length>0">
                                                    <div *ngFor="let impuesto of detalle.value['impuestos']"
                                                        style="font-size: 12px;">
                                                        <strong>({{ impuesto['tipo'].trim().toLowerCase() == 'traslado'
                                                            ? '+' : '-' }})</strong>
                                                        {{ impuesto['nombre'] }} =
                                                        {{ impuesto['total'] | currency }}
                                                    </div>
                                                </div>
                                                <div *ngIf="detalle.value['impuestos'].length<=0">
                                                    <small>--</small>
                                                </div>
                                            </td>
                                            <td style="text-align: right;">
                                                <strong class="text-primary">
                                                    {{ detalle.value['total'] | currency }}
                                                </strong>
                                            </td>
                                            <td style="text-align:right;">
                                                <div *ngIf="form.get('tipo_comprobante')?.value!='P'">
                                                    <button type="button" class="btn btn-danger btn-sm"
                                                        (click)="deleteDetail(i)">
                                                        <i class="fas fa-trash-alt fa-sm fa-fw"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm"
                                                    (click)="nuevaLinea()">
                                                    <i class="fas fa-plus fa-xs fa-fw"></i> Nueva entrada
                                                </button>
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td style="text-align:right;">
                                                <!-- <strong class="text-danger">
                                                    {{ total_cotizacion | currency }}
                                                </strong> -->
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div><!--Div Row-->

                        <div class="row">
                            <div class="col-6"></div>
                            <div class="col-6">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td style="text-align:right;"><strong>Subtotal (+):</strong></td>
                                            <td style="text-align:right;" [style]="'width:40%'">
                                                {{ form.get('subtotal')?.value | currency }}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:right;"><strong>Descuento (-):</strong></td>
                                            <td style="text-align:right;" [style]="'width:40%'">
                                                {{ form.get('descuento')?.value | currency }}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:right;"><strong>T. Federal (+):</strong></td>
                                            <td style="text-align:right;">
                                                <strong>{{ form.get('traslados')?.value | currency }}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:right;"><strong>R. Federal (-):</strong></td>
                                            <td style="text-align:right;">
                                                {{ form.get('retencion')?.value | currency }}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:right;"><strong>Total (=):</strong></td>
                                            <td style="text-align:right;">
                                                {{ form.get('total')?.value | currency }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div><!--Div Container Fluid-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal"
                        (click)="modal.close('No')">
                        <i class="fas fa-times fa-lg fa-fw"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm" aria-label="">
                        <i class="fas fa-save fa-lg fa-fw"></i>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </ng-template>

</section>
